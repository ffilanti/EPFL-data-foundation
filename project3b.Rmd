---
title: "Project3b"
author: "F. Filanti"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: yes
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# **PART 1 - Library & Data sources**

### Chargement des librairies nécessaires

```{r echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
```

### Chargement des données externes

```{r message=FALSE, warning=FALSE}
fitness_members <- read_csv("D:/Fabrice/Documents/R/Project3/fitness_members.csv")
fitness_tracking <- read_csv("D:/Fabrice/Documents/R/Project3/fitness_tracking.csv")
```

# **PART 2 - Answers to questions**

### Nombre de recommandations du membre  000115

```{r echo=FALSE, message=FALSE, warning=FALSE}
nb_of_recommendation <- fitness_members %>%
  filter(recommendation_from != "NA") %>%
  group_by(recommendation_from) %>%
  summarise(number_recommendation = n()) %>%
  select(recommendation_from, number_recommendation) %>%
  ungroup()

fitness_members <-
  left_join(fitness_members, nb_of_recommendation, by = c("id" = "recommendation_from")) %>%
  collect()

fitness_members %>%
  filter(id == "000115") %>%
  select(id, number_recommendation)
```

### Membre avec le plus grand nombre de recommandations

```{r echo=FALSE, message=FALSE, warning=FALSE}
fitness_members %>%
  filter(number_recommendation == max(number_recommendation, na.rm = TRUE)) %>%
  select(id, number_recommendation)
```

### Combien de femmes membres dans la catégorie Premium ont fait une ou plusieurs recommandations ?

```{r echo=FALSE, message=FALSE, warning=FALSE}
fitness_members %>%
  filter(gender == "F", number_recommendation >= 1, m_category == "Premium", na.rm = TRUE) %>%
  group_by(gender, number_recommendation) %>%
  summarise(number_of_members_with_successfull_recommendation = n()) %>%
  ungroup()
```
### Calcul du BMI

```{r echo=FALSE, message=FALSE, warning=FALSE}
BMI_data <- fitness_members %>%
  mutate(BMI = weight / ((height / 100)**2)) %>%
  select(id, BMI)
```

### BMI du membre 000142

```{r echo=FALSE, message=FALSE, warning=FALSE}
BMI_data %>%
  filter(id == "000042") %>%
  select(id, BMI)
```

### Membres n'ayant pas encore atteint la semaine 1

```{r echo=FALSE, message=FALSE, warning=FALSE}
left_join(fitness_members, fitness_tracking, by = c("id")) %>%
  filter(is.na(wk_001) | wk_001 == "NA") %>%
  select(id)
```
### Création de la tibble "fitness_tracking_long" en pivoting la tibble "fitness_tracking"

```{r echo=TRUE, message=FALSE, warning=FALSE}
fitness_tracking <-
  fitness_tracking %>%
  mutate(wk_000 = 0, .after = id)

fitness_tracking_long <- 
  fitness_tracking %>%
    pivot_longer(
      cols = starts_with("wk"),
      names_to = "week",
      values_to = "week_weight"
    )

week_000 <-
  fitness_members %>%
  rename(week_weight = weight) %>%
  mutate(week = "wk_000") %>%
  select(id, week, week_weight)

fitness_tracking_long <-
  bind_rows(fitness_tracking_long, week_000) %>%
  filter(week_weight != 0) %>%
  mutate(week = as.numeric(str_remove(week, "wk_"))) %>%
  arrange(id, week)
```

### Calcul des BMI hebdomadaires

```{r echo=TRUE, error=FALSE, message=TRUE, warning=FALSE}
weekly_BMI <- 
  inner_join(fitness_tracking_long, fitness_members, by = c("id")) %>%
    mutate(BMI = round(week_weight / ((height / 100)**2), digits = 2)) %>%
    select(id, week, BMI)

weekly_BMI %>%
  filter(id == "000024", week == 11) %>%
  print(id, week, BMI)
```

### Calcul du pourcentage de variation du BMI d'une semaine à l'autre

```{r echo=FALSE, message=FALSE, warning=FALSE}
weekly_BMI %>%
  group_by(id) %>%
  mutate(BMIchange_pct = (round(BMI, digits = 1) / lag(round(BMI, digits = 1)) - 1) * 100) %>%
  mutate(BMIchange_pct = round(BMIchange_pct, digits = 2)) %>%
  mutate(BMIchange_pct = str_glue("{BMIchange_pct}%")) %>%
  select(id, week, BMI, BMIchange_pct) %>%
  filter(id == "000015", week == 7)
```
